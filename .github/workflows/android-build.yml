name: Build Android APK (Buildozer)

on:
  workflow_dispatch:
  push:
    paths:
      - 'android/**'
      - '.github/workflows/android-build.yml'
      - 'main.py'
      - 'game/**'
      - 'data/**'
      - 'assets/**'
      - 'Fond/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Python 3.10 (host)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git zlib1g-dev libncurses5-dev libstdc++6 libffi-dev libssl-dev autoconf libtool pkg-config cmake unzip

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK/NDK components
        run: |
          yes | sdkmanager --licenses
          # Ensure modern cmdline-tools are installed under cmdline-tools/latest
          sdkmanager --install "cmdline-tools;latest"
          sdkmanager --install "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;25.1.8937393"
          echo "Using ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "Listing cmdline-tools:"; ls -la "$ANDROID_SDK_ROOT/cmdline-tools" || true
          echo "sdkmanager from latest:"; "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --version || true
          echo "Removing legacy SDK tools directory if present to avoid old sdkmanager..."
          if [ -d "$ANDROID_SDK_ROOT/tools" ]; then rm -rf "$ANDROID_SDK_ROOT/tools"; fi

      - name: Install buildozer and python deps
        run: |
          python -m pip install --upgrade pip cython
          python -m pip install --upgrade buildozer

      - name: Show spec file
        run: |
          ls -la
          ls -la android
          sed -n '1,200p' android/buildozer.spec || true

      - name: Build debug APK with Buildozer
        working-directory: "android"
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROIDSDK: ${{ env.ANDROID_SDK_ROOT }}
          ANDROIDNDK: ${{ env.ANDROID_SDK_ROOT }}/ndk/25.1.8937393
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/25.1.8937393
          ANDROID_NDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}/ndk/25.1.8937393
          ANDROID_NDK: ${{ env.ANDROID_SDK_ROOT }}/ndk/25.1.8937393
          ANDROIDAPI: "33"
          ANDROIDMINAPI: "21"
          ANDROID_BUILD_TOOLS_VERSION: "33.0.2"
          # Force Buildozer/p4a to use the modern sdkmanager (avoid deprecated tools/bin)
          SDKMANAGER: ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest/bin/sdkmanager
        run: |
          mkdir -p build-logs
          echo "java -version:"; java -version || true
          echo "Using SDK at: $ANDROID_SDK_ROOT" || true
          echo "Installed Build-Tools:" || true
          ls -la "$ANDROID_SDK_ROOT/build-tools" || true
          # Prefer cmdline-tools/latest and ensure it's ahead in PATH so p4a finds it
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/build-tools/33.0.2:$PATH"
          echo "Ensuring legacy tools are absent before build..."
          if [ -d "$ANDROID_SDK_ROOT/tools" ]; then rm -rf "$ANDROID_SDK_ROOT/tools"; fi
          echo "sdkmanager binary in PATH:"; which sdkmanager || true
          sdkmanager --version || true
          buildozer -v android debug 2>&1 | tee build-logs/buildozer_console.log

      - name: Post-mortem listing (always)
        if: always()
        run: |
          echo "=== List android/bin ===" || true
          ls -la android/bin || true
          echo "=== Tail android/.buildozer/log ===" || true
          find android/.buildozer -type f -name "*.log" -print -exec tail -n 200 {} \; || true
          echo "=== Tail home .buildozer logs ===" || true
          find $HOME/.buildozer -type f -name "*.log" -print -exec tail -n 200 {} \; || true
          echo "=== Tail buildozer_console.log (last 400 lines) ===" || true
          tail -n 400 android/build-logs/buildozer_console.log || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: minefut-apk
          path: |
            android/bin/*.apk

      - name: Upload Buildozer logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-logs
          path: |
            android/.buildozer/**
            android/build-logs/**
            /home/runner/.buildozer/**
          if-no-files-found: warn
